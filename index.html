<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MC3 AUTO PARTS — Inventory (Public + Admin)</title>

<!-- Embedded style (you can move to style.css if you want) -->
<style>
:root{
  --bg:#0f0f10; --panel:#141414; --muted:#9aa0a6; --accent:#00d27a; --danger:#ff5a5a;
  --card:#151515; --border:#2a2a2a;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#eee}
.header{
  display:flex;align-items:center;justify-content:space-between;
  padding:18px 20px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#121212,#0f0f10);
}
.brand h1{margin:0;font-size:20px;letter-spacing:1px}
.brand p{margin:0;color:var(--muted);font-size:13px}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:var(--accent);color:#062; padding:8px 12px;border-radius:8px;font-weight:700;text-decoration:none;border:none;cursor:pointer}
.btn-secondary{background:transparent;border:1px solid var(--border);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}
.container{padding:18px;max-width:1200px;margin:0 auto}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
.input,select{background:transparent;border:1px solid var(--border);padding:10px 12px;color:#eee;border-radius:8px;min-width:160px}
.input.flex{flex:1;min-width:220px}
.tableWrap{background:var(--card);border-radius:8px;border:1px solid var(--border);overflow:auto}
table{width:100%;border-collapse:collapse;min-width:900px}
th,td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--border);vertical-align:top}
th{background:#111;font-size:13px;color:var(--muted)}
td small{color:var(--muted)}
.low{background:var(--danger);color:#fff;padding:2px 6px;border-radius:6px;font-size:12px}

.grid{display:grid;grid-template-columns:1fr 320px;gap:16px}
.rightPanel{background:var(--panel);padding:14px;border-radius:8px;border:1px solid var(--border);min-height:320px}
.rightPanel h3{margin-top:0}
.field{margin-bottom:8px}
.field label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
.field input, .field textarea, .field select{width:100%;padding:10px;border-radius:6px;background:transparent;border:1px solid var(--border);color:#fff}
.field textarea{min-height:120px;resize:vertical}

.row-actions{display:flex;gap:8px;margin-top:10px}
.btn-red{background:var(--danger);color:white}
.small{padding:6px 8px;font-size:13px;border-radius:6px}

.footer{padding:18px;text-align:center;color:var(--muted);font-size:13px;border-top:1px solid var(--border);margin-top:18px}

/* login modal */
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:999}
.modalCard{background:#0e0e0e;padding:20px;border-radius:10px;border:1px solid var(--border);width:360px}
.modalCard h2{margin:0 0 10px 0}
.center{text-align:center}
.hidden{display:none}

/* responsive */
@media(max-width:920px){
  .grid{grid-template-columns:1fr}
  table{min-width:720px}
}
</style>

</head>
<body>

<!-- Header -->
<header class="header">
  <div class="brand">
    <h1>MC3 AUTO PARTS</h1>
    <p>Inventory • Cabin / Air / Oil Filters</p>
  </div>
  <div class="controls">
    <button id="adminBtn" class="btn-secondary">Admin</button>
  </div>
</header>

<!-- Content -->
<div class="container">
  <div class="toolbar">
    <input id="search" class="input flex" placeholder="Search code / brand / type / fitment..." />
    <select id="filterType" class="input">
      <option value="">All Types</option>
      <option value="AIR">AIR</option>
      <option value="CABIN">CABIN</option>
      <option value="OIL">OIL</option>
    </select>
    <select id="sortBy" class="input">
      <option value="">Sort — None</option>
      <option value="code">Code A→Z</option>
      <option value="brand">Brand A→Z</option>
      <option value="stock_desc">Stock High→Low</option>
    </select>
    <button id="btnReload" class="btn-secondary small">Reload JSON</button>
  </div>

  <div class="tableWrap">
    <table id="mainTable" aria-live="polite">
      <thead>
        <tr>
          <th>Code</th><th>Type</th><th>Brand</th><th>Fitment</th><th>Stock</th><th>Retail ₱</th><th>Wholesale ₱</th><th>Action</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div style="height:12px"></div>

  <div class="grid">
    <!-- left area is empty because main table already shown; right panel editor -->
    <div></div>

    <aside class="rightPanel" id="panel">
      <h3>ADMIN PANEL (locked)</h3>
      <div id="adminControls" class="hidden">
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <button id="addItem" class="btn small">+ Add Item</button>
          <button id="saveLocal" class="btn small">Save (Local)</button>
          <button id="downloadJSON" class="btn small">Download JSON</button>
        </div>

        <div style="display:flex;gap:8px;margin-bottom:10px;align-items:center">
          <label class="btn small" for="fileImport">Import .xlsx</label>
          <input id="fileImport" type="file" accept=".xlsx,.xls" style="display:none" />
          <button id="exportXLS" class="btn small">Export .xlsx</button>
          <button id="loadDefault" class="btn-secondary small">Load Default</button>
        </div>

        <div style="height:10px"></div>

        <div id="editorNotice">Select a row from table to edit (click Edit).</div>

        <div id="editor" class="hidden" style="margin-top:10px">
          <div class="field"><label>Code</label><input id="e_code" /></div>
          <div class="field"><label>Type</label><input id="e_type" /></div>
          <div class="field"><label>Brand</label><input id="e_brand" /></div>
          <div class="field"><label>Fitment</label><textarea id="e_fitment"></textarea></div>
          <div class="field"><label>Stock</label><input id="e_stock" type="number" /></div>
          <div class="field"><label>Retail ₱</label><input id="e_retail" type="number" /></div>
          <div class="field"><label>Wholesale ₱</label><input id="e_wholesale" type="number" /></div>

          <div class="row-actions">
            <button id="saveRow" class="btn small">Save Row</button>
            <button id="deleteRow" class="btn-red small">Delete Row</button>
          </div>
        </div>
      </div>

      <div id="adminLocked" class="center">
        <p style="color:var(--muted)">Admin functions are locked. Click <strong>Admin</strong> to unlock (password).</p>
        <p style="font-size:12px;color:var(--muted)">When unlocked, you can import/export, add, edit, delete & download inventory.json.</p>
      </div>
    </aside>
  </div>

  <div class="footer">© MC3 AUTO PARTS — Direct Import • High Quality • Low Price</div>
</div>

<!-- Login Modal -->
<div id="modal" class="modal hidden" role="dialog" aria-modal="true">
  <div class="modalCard">
    <h2 class="center">Admin Login</h2>
    <div style="margin:10px 0">
      <input id="pw" placeholder="Enter admin password" style="width:100%;padding:10px;border-radius:6px;background:transparent;border:1px solid var(--border);color:#fff"/>
    </div>
    <div style="display:flex;gap:8px;justify-content:center">
      <button id="btnOk" class="btn">Unlock</button>
      <button id="btnCancel" class="btn-secondary">Cancel</button>
    </div>
    <p style="color:var(--muted);font-size:13px;margin-top:10px">Admin password required to enable edit features.</p>
  </div>
</div>

<!-- SheetJS for import/export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- App logic -->
<script>
/* -------------------------- default inventory (from your CSV) ------------------------- */
const defaultInventory = [
  {"code":"MR398288","type":"CABIN","brand":"MITSUBISHI","fitment":"(Lancer 2002-2007) (Outlander 2003-2006) (Grandis 2003-2011)","stock":10,"retail":136.5,"wholesale":126},
  {"code":"87139-0N010","type":"CABIN","brand":"TOYOTA","fitment":"(Hiace Commuter 2004-present) (Hiace Grandia 2004-present)","stock":20,"retail":65,"wholesale":60},
  {"code":"17801-0L040","type":"AIR","brand":"TOYOTA","fitment":"(Fortuner 2015–present) (Innova 2016–present) (Hilux 2015–present)","stock":28,"retail":162.5,"wholesale":150},
  {"code":"17801-BZ100","type":"AIR","brand":"TOYOTA","fitment":"(Wigo 2014-2017) (Agya 2013-2017)","stock":20,"retail":111,"wholesale":93.75},
  {"code":"1500A608","type":"AIR","brand":"MITSUBISHI","fitment":"(Montero 2016-2021) (Strada 2018-present) (L200/Triton 2016-present)","stock":46,"retail":150,"wholesale":130},
  {"code":"17801-0Y040","type":"AIR","brand":"TOYOTA","fitment":"(Mirage 2013-2019) (Sienta 2016-2019) (Vios 2013-2019) (Yaris 2014-2019)","stock":0,"retail":105,"wholesale":95},
  {"code":"1500A617","type":"AIR","brand":"MITSUBISHI","fitment":"(Mirage G4 2012-2021) (Mirage Hatchback 2012-2019)","stock":20,"retail":98,"wholesale":90},
  {"code":"7850A002","type":"CABIN","brand":"MITSUBISHI","fitment":"(Mirage 2014–present) (Mirage G4 2014–present)","stock":10,"retail":77,"wholesale":65},
  {"code":"7803A112","type":"CABIN","brand":"MITSUBISHI","fitment":"(Montero 2016–Up) (Strada 2015–2022) (L200 2015–2022)","stock":20,"retail":130,"wholesale":120},
  {"code":"97133-2E210","type":"AIR","brand":"HYUNDAI","fitment":"(Accent 2011-2017) (Tucson 2006-2014) (Veloster 2011-2017)","stock":10,"retail":98,"wholesale":84}
];

const STORAGE_KEY = 'mc3inventory_online_v1';
let inventory = [];
let editingIndex = null;

/* ---------- helpers ---------- */
function escapeHtml(s){
  if(s===null||s===undefined) return '';
  return String(s).replace(/[&<>"'`]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[c]));
}

/* ---------- load inventory (localStorage or default) ---------- */
function loadInventory(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){
    try{
      inventory = JSON.parse(raw);
      return;
    }catch(e){}
  }
  // try to load inventory.json from repo if exists (optional)
  fetch('inventory.json').then(r=>{
    if(!r.ok) throw new Error('no repo inventory');
    return r.json();
  }).then(j=>{
    inventory = j;
    saveLocal(false);
    render();
  }).catch(()=>{ inventory = defaultInventory.slice(); saveLocal(false); render(); });
}

/* ---------- render table ---------- */
function render(){
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  const q = document.getElementById('search').value.trim().toLowerCase();
  const typeFilter = document.getElementById('filterType').value;
  const sortBy = document.getElementById('sortBy').value;

  let items = inventory.filter(it => {
    if(typeFilter && it.type !== typeFilter) return false;
    if(!q) return true;
    const txt = (it.code + ' ' + it.brand + ' ' + it.type + ' ' + it.fitment).toLowerCase();
    return txt.includes(q);
  });

  if(sortBy === 'code') items.sort((a,b)=> (a.code||'').localeCompare(b.code||''));
  if(sortBy === 'brand') items.sort((a,b)=> (a.brand||'').localeCompare(b.brand||''));
  if(sortBy === 'stock_desc') items.sort((a,b)=> Number(b.stock) - Number(a.stock));

  items.forEach((it, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(it.code)}</td>
      <td>${escapeHtml(it.type)}</td>
      <td>${escapeHtml(it.brand)}</td>
      <td>${escapeHtml(it.fitment)}</td>
      <td>${escapeHtml(String(it.stock))} ${Number(it.stock) <= 5 ? '<span class="low">LOW</span>':''}</td>
      <td>₱${escapeHtml(String(it.retail))}</td>
      <td>₱${escapeHtml(String(it.wholesale))}</td>
      <td><button class="btn-secondary small" data-idx="${idx}" onclick="onEdit(${idx})">Edit</button></td>
    `;
    tbody.appendChild(tr);
  });
}

/* ---------- save local ---------- */
function saveLocal(alertUser=true){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(inventory));
  if(alertUser) { alert('Saved locally (browser)'); }
}

/* ---------- download inventory.json ---------- */
function downloadJSON(){
  const blob = new Blob([JSON.stringify(inventory, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'inventory.json'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* ---------- admin lock / unlock ---------- */
const ADMIN_PASSWORD = 'mc3admin0211';
function showModal(show=true){ document.getElementById('modal').classList.toggle('hidden', !show); }
document.getElementById('adminBtn').addEventListener('click', ()=> showModal(true));
document.getElementById('btnCancel').addEventListener('click', ()=> showModal(false));
document.getElementById('btnOk').addEventListener('click', ()=>{
  const p = document.getElementById('pw').value.trim();
  if(p === ADMIN_PASSWORD){
    showModal(false);
    enableAdmin();
  } else alert('Incorrect password');
});

/* ---------- enable admin view ---------- */
function enableAdmin(){
  document.getElementById('adminLocked').classList.add('hidden');
  document.getElementById('adminControls').classList.remove('hidden');
  document.getElementById('panel').scrollIntoView({behavior:'smooth'});
}

/* ---------- edit flow ---------- */
function onEdit(idx){
  editingIndex = idx;
  const it = inventory[idx];
  document.getElementById('editor').classList.remove('hidden');
  document.getElementById('editorNotice').classList.add('hidden');
  document.getElementById('e_code').value = it.code || '';
  document.getElementById('e_type').value = it.type || '';
  document.getElementById('e_brand').value = it.brand || '';
  document.getElementById('e_fitment').value = it.fitment || '';
  document.getElementById('e_stock').value = it.stock || 0;
  document.getElementById('e_retail').value = it.retail || 0;
  document.getElementById('e_wholesale').value = it.wholesale || 0;
  window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
}

document.getElementById('saveRow').addEventListener('click', ()=>{
  if(editingIndex===null){ alert('No row selected'); return; }
  const idx = editingIndex;
  inventory[idx].code = document.getElementById('e_code').value.trim();
  inventory[idx].type = document.getElementById('e_type').value.trim();
  inventory[idx].brand = document.getElementById('e_brand').value.trim();
  inventory[idx].fitment = document.getElementById('e_fitment').value.trim();
  inventory[idx].stock = Number(document.getElementById('e_stock').value) || 0;
  inventory[idx].retail = Number(document.getElementById('e_retail').value) || 0;
  inventory[idx].wholesale = Number(document.getElementById('e_wholesale').value) || 0;
  editingIndex = null;
  document.getElementById('editor').classList.add('hidden');
  document.getElementById('editorNotice').classList.remove('hidden');
  render();
  saveLocal();
});

document.getElementById('deleteRow').addEventListener('click', ()=>{
  if(editingIndex===null) return alert('No row selected');
  if(!confirm('Delete this row?')) return;
  inventory.splice(editingIndex, 1);
  editingIndex = null;
  document.getElementById('editor').classList.add('hidden');
  document.getElementById('editorNotice').classList.remove('hidden');
  render();
  saveLocal();
});

/* ---------- add item ---------- */
document.getElementById('addItem').addEventListener('click', ()=>{
  const newItem = { code:'', type:'', brand:'', fitment:'', stock:0, retail:0, wholesale:0 };
  inventory.unshift(newItem);
  render();
  onEdit(0);
  saveLocal(false);
});

/* ---------- import .xlsx (SheetJS) ---------- */
document.getElementById('fileImport').addEventListener('change', (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, {type:'array'});
    const first = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(first, {header:1, defval:''});
    if(rows.length<2) return alert('No data found in sheet');
    const header = rows[0].map(h=>String(h||'').toLowerCase());
    const out = [];
    for(let r=1;r<rows.length;r++){
      const row = rows[r];
      if(!row || row.length===0) continue;
      const obj = {
        code: row[header.indexOf('code')] || '',
        type: row[header.indexOf('type')] || '',
        brand: row[header.indexOf('brand')] || '',
        fitment: row[header.indexOf('fitment')] || '',
        stock: Number(row[header.indexOf('stock')] || 0),
        retail: Number(row[header.indexOf('retail')] || 0),
        wholesale: Number(row[header.indexOf('wholesale')] || 0)
      };
      out.push(obj);
    }
    if(out.length===0) return alert('No rows imported');
    if(confirm('Replace inventory with imported file? OK=replace, Cancel=append')){
      inventory = out;
    } else {
      inventory = out.concat(inventory);
    }
    render(); saveLocal(); alert('Import complete: ' + out.length + ' rows');
  };
  reader.readAsArrayBuffer(f);
  // clear input
  ev.target.value='';
});

/* ---------- export xlsx ---------- */
document.getElementById('exportXLS').addEventListener('click', ()=>{
  const ws_data = [['code','type','brand','fitment','stock','retail','wholesale']];
  inventory.forEach(it => ws_data.push([it.code,it.type,it.brand,it.fitment,it.stock,it.retail,it.wholesale]));
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Inventory'); XLSX.writeFile(wb, 'mc3_inventory.xlsx');
});

/* ---------- load default ---------- */
document.getElementById('loadDefault').addEventListener('click', ()=>{
  if(!confirm('Load default inventory and overwrite current?')) return;
  inventory = defaultInventory.slice();
  render(); saveLocal(); alert('Default loaded');
});

/* ---------- export json ---------- */
document.getElementById('downloadJSON').addEventListener('click', downloadJSON);

/* ---------- quick reload (attempt fetch inventory.json) ---------- */
document.getElementById('btnReload').addEventListener('click', ()=>{
  fetch('inventory.json').then(r=>{
    if(!r.ok) throw new Error('no file');
    return r.json();
  }).then(j=>{
    inventory = j; saveLocal(false); render(); alert('Loaded inventory.json from repo');
  }).catch(()=> alert('No inventory.json found in repo root (optional). Use Download JSON to upload file manually)'));
});

/* ---------- search / filters ---------- */
document.getElementById('search').addEventListener('input', render);
document.getElementById('filterType').addEventListener('change', render);
document.getElementById('sortBy').addEventListener('change', render);

/* ---------- initial load ---------- */
loadInventory();

/* ---------- expose onEdit globally for table buttons (used in inline onclick) ---------- */
window.onEdit = onEdit;
</script>

</body>
</html>
